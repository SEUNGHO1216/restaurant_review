{% extends 'base.html' %}
{% block head %}
<style>
    .container{
        margin:auto;
    }
    .title-box{
        background-color: gold;
    }
    .info-box{
        background-color: whitesmoke;
        display: flex;
    }
    .delbtn{
        margin-top: 14px;

    }
    .filebox{
        display: flex;
    }
    .fileread{
        min-width: 350px;

    }
    .map-fail-text{
        font-size: 12px;
        color: dimgray;
    }
    .reply-box{
        display: flex;
    }
    .editing{
        font-size: 16px;
        color:dimgray;
    }
    .editing-box{
        display: flex;
        border-bottom: 4px dashed ;
    }
    .updateDt{
        font-size: 12px;
        color:dimgray;
    }
     .likey-btn {
            border-style: hidden;
            background-color: transparent;
    }
     .unliky_btn {
        border-style: hidden;
        background-color: transparent;
    }
</style>
<script>
    function like(){
        alert("ë¡œê·¸ì¸ í›„ì— 'ì¢‹ì•„ìš”'ë¥¼ ëˆ„ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    }
    function loginReply(){
        let id=$('#replyId').val()
        let pw=$('#replyPassword').val()
        $.ajax({
            type:"POST",
            url:"/loginReply",
            data:{id:id, pw:pw},
            success:function (response){
                console.log(response['msg'])
                window.location.reload();
            }
        })
    }
    function addReply(){
        let con=$('#reply-text').val()
        $.ajax({
            type:"POST",
            url:"/addReply/{{ doc.id }}/{{ page }}",
            data:{con:con},
            success:function (response){
                alert(response['msg'])
                window.location.reload();
            }
        })
    }

    // $(document).ready(function(){
    //     $('#replyEdit').onclick(function ())
    // })
    function replyEdit(context,rid){
        alert('\'ìˆ˜ì •\'ì€ ëŒ“ê¸€ ë§¨ ìœ„ ì¹¸ì—ì„œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.')
        let replyId=rid
        let cont=context
        let html_temp=`
                        <span class="editing"><b>ìˆ˜ì • ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!</b></span>
                        <div class="form-inline mb-2">
                            <span><b>{{ session['id'] }}</b></span>
                        </div>
                       <div class="editing-box">
                             <div class="col-lg-10">
                                <textarea class="form-control" id="replyEditText" rows="3">${cont}</textarea>
                            </div>
                            <div class="col-lg-2" id="edit-box">
                                <button onclick="javascript:replyEditSave('${replyId}')" type="button"  id="replyEdit">ì™„ë£Œ</button>
                                <a href="/detail/{{ doc.id }}/{{ page }}"><button id="replyDel">ì·¨ì†Œ</button></a>
                            </div>
                        </div>
                      `
        $('#replyEdit-box').html(html_temp)

    }

    function replyEditSave(rid){
        let ridInfo = rid
        let con = $('#replyEditText').val()
        $.ajax({
            type:"POST",
            url:"/editReply",
            data:{con:con, rid:ridInfo},
            success: function(response){
                alert(response['msg'])
                window.location.reload()
            }

        })

    }


</script>
{% endblock %}
{% block content %}

    <div class="container col-lg-7 mt-5 rounded-lg">
        <div class="title-box mb-3">
            <div class="text-center shadow p-2">
                <div>
                    <span><h6>[{{ doc.category }}]</h6>
                        <h1>{{ doc.title }}</h1></span>
                </div>
            </div>
        </div>
        <div class="info-box col-log-12 mb-3 shadow-sm p-1 mb-5 bg-light rounded">
            <div class="row col-lg-3">
                <label><b>ì‘ì„±ì</b></label>
                <div>
                    <span><b>{{ doc.writer }}</b></span>
                </div>
            </div>
             <div class="row col-lg-3">
                <label><b>ì¡°íšŒìˆ˜</b></label>
                <div>
                    <span><b>{{ doc.view_cnt }}</b></span>
                </div>
            </div>
            <div class="row col-lg-3">
                <label><b>ê²Œì‹œì¼</b></label>
                <div>
                    <span><b>{{ doc.pubdate }}</b></span>
                </div>
                {% if doc.uptdate %}
                <div>
                    <span><b>{{ doc.uptdate }}</b></span>
                </div>
                {% endif %}
            </div>
            <div class="row col-lg-3" id="likey-box">

                <div>
                    {% if session['id'] in doc.likey %}
                        <label><b>ì¢‹ì•„ìš” ì·¨ì†Œ</b></label>
                        <a href="/unlikey/{{doc.id}}/{{ page }}">
                            <button class="unliky_btn">ğŸ˜¢</button>
                        </a>
                        <span><b>{{ doc.likey|length }}</b></span>
                    {% else %}
                        {% if session['id'] %}
                            <label><b>ì¢‹ì•„ìš”</b></label>
                            <a href="/likey/{{doc.id}}/{{ page }}">
                                <button class="likey-btn">ğŸ’–</button>
                            </a>
                            <span><b>{{ doc.likey|length }}</b></span>
                        {% else %}
                            <label><b>ì¢‹ì•„ìš”</b></label>
                            <button onclick="like()" >ğŸ’–</button></a><span><b>{{ doc.likey|length }}</b></span>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="content-box col-lg-12 mb-3">
            <span><b>ë§›ì§‘ ì½”ë©˜íŠ¸</b></span>
            <div class="board-body col-lg-12 shadow p-2 mb-5 bg-body rounded">
                {{ doc.comment }}
            </div>
            <span><b>ë³¸ë¬¸</b></span>
            <div class="board-body col-lg-12 shadow p-3 mb-5 bg-body rounded">
                <!--<textarea id="contents" name="contents">-->{% autoescape false %}{{ doc.content }}{% endautoescape %}<!--</textarea>-->
            </div>

            <div class="input-group mt-3 mb-3">
                {% for n in doc.file %}
                <form action = "/filedown" method = "POST" enctype = "multipart/form-data" class="filebox">
                    <input type = "text" name = "file" value="{{ n }}" class="form-control fileread" readonly/>
                    <input type = "submit" value="íŒŒì¼ë°›ê¸°" class="btn btn-outline-dark downbutton"/>
                </form>
                {% endfor %}
            </div>
            {% if doc.map['address'] %}
            <span><b>ì§€ë„</b></span>
            <p class="map-fail-text">ğŸ‘€ì§€ë„ê°€ ì˜ ë‚˜ì˜¤ì§€ ì•ŠëŠ”ë‹¤ë©´ ì…ë ¥í•˜ì‹  ì£¼ì†Œê°€ '{{ doc.map["address"] }}'ì´(ê°€) ë§ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”! </p>
            <div id="map" style="width:100%;height:350px;"></div>
            {% endif %}

            <div class="card mb-2">
                <div class="card-header bg-light">
                        <i class="fa fa-comment fa"></i> ëŒ“ê¸€
                </div>
                <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                {% if session['id'] %}
                                <div class="form-inline mb-2">
                                    <label for="replyId"><i class="fa fa-user-circle-o fa-2x">ì‘ì„±ì</i></label>
                                    <input type="text" class="form-control ml-2" value="{{ session['id'] }}" id="replyId-logged" readonly>
                                </div>
                                <textarea class="form-control" id="reply-text" rows="3" placeholder="ëŒ“ê¸€ì…ë ¥" required></textarea>
                                <button type="button" class="btn btn-dark mt-3" onclick="javascript:addReply();">ëŒ“ê¸€ ê²Œì‹œ</button>
                                <hr>
                                {% else %}
                                <span>ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ì„ ë‚¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                                <div class="form-inline mb-2">
                                    <label for="replyId"><i class="fa fa-user-circle-o fa-2x"></i></label>
                                    <input type="text" class="form-control ml-2" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" name="replyId" id="replyId">
                                    <label for="replyPassword" class="ml-4"><i class="fa fa-unlock-alt fa-2x"></i></label>
                                    <input type="password" class="form-control ml-2" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" name="replyPassword" id="replyPassword">
                                </div>
                                <button type="button" class="btn btn-dark mt-3" onclick="javascript:loginReply();">ë¡œê·¸ì¸</button>
                                <hr>
                                {% endif %}
                                 <div id="replyEdit-box"></div>
                                <div id="reply-box">
                                  {% if replies %}
                                    {% for i in replies %}
                                    <div class="form-inline mb-2">
                                        <span><b>{{ i.writer }}</b></span>
                                    </div>
                                    <div id="reply-box2" class="reply-box">
                                        <div class="col-lg-10">
                                            <textarea class="form-control" id="replyText" rows="3" disabled>{% autoescape false %}{{ i.context }}{% endautoescape %}</textarea>
                                        </div>
                                        {% if session['id'] == i.writer %}
                                        <div class="col-lg-2" id="edit-box">
                                            <button onclick="javascript:replyEdit('{% autoescape false %}{{ i.context }}{% endautoescape %}','{{ i._id }}');" type="button"  id="replyEdit">ìˆ˜ì •</button>
                                            <a href="/deleteReply/{{ i._id }}/{{ doc.id }}/{{ page }}"><button id="replyDel">ì‚­ì œ</button></a><br>
                                            <span class="text-end">{{ i.pubdate }}</span><br>
                                            {% if i.updateDt %}
                                                  <span class="text-end updateDt">ìˆ˜ì •: {{ i.updateDt }}</span>
                                            {% endif %}

                                        </div>
                                        {% else %}
                                         <div class="col-lg-2" id="edit-box2">
                                            <span class="text-end">{{ i.pubdate }}</span><br>
                                            {% if i.updateDt %}
                                                  <span class="text-end updateDt">ìˆ˜ì •: {{ i.updateDt }}</span>
                                            {% endif %}

                                        </div>
                                        {% endif %}

                                    </div>
                                    <hr>
                                    {% endfor %}
                                {% endif %}
                                </div>
                            </li>
                        </ul>
                </div>
            </div>
            <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=34dc520af852051eb432527a823c37c0&libraries=services"></script>
            <script>
            var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div
                mapOption = {
                    center: new kakao.maps.LatLng(33.450701, 126.570667), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
                    level: 3 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
                };

            // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
            var map = new kakao.maps.Map(mapContainer, mapOption);

            // ì£¼ì†Œ-ì¢Œí‘œ ë³€í™˜ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
            var geocoder = new kakao.maps.services.Geocoder();

            // ì£¼ì†Œë¡œ ì¢Œí‘œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤

            geocoder.addressSearch('{{ doc.map["address"] }}', function(result, status) {

                // ì •ìƒì ìœ¼ë¡œ ê²€ìƒ‰ì´ ì™„ë£Œëìœ¼ë©´
                 if (status === kakao.maps.services.Status.OK) {

                    var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                    // ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¥¼ ë§ˆì»¤ë¡œ í‘œì‹œí•©ë‹ˆë‹¤
                    var marker = new kakao.maps.Marker({
                        map: map,
                        position: coords
                    });

                    // ì¸í¬ìœˆë„ìš°ë¡œ ì¥ì†Œì— ëŒ€í•œ ì„¤ëª…ì„ í‘œì‹œí•©ë‹ˆë‹¤
                    var infowindow = new kakao.maps.InfoWindow({
                        content: '<div style="width:170px;text-align:center;padding:6px 0;white-space: nowrap;overflow: auto;"><b>{{ doc.map['place'] }}</b><br>' +
                            '<span style="font-size: 12px">{{ doc.map['address'] }}</span><br><a href="{{ doc.map['url'] }}" target="_blank">ìƒì„¸ì •ë³´</a></div>'
                    });
                    infowindow.open(map, marker);

                    // ì§€ë„ì˜ ì¤‘ì‹¬ì„ ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤
                    map.setCenter(coords);
                }
            });
            </script>

            <div class="text-end btns">
                <a href="{{ url_for('index', page=page) }}"><button type="button" class="btn btn-outline-dark mt-3 text-end">ëŒì•„ê°€ê¸°</button></a>
                {% if session['id'] == doc.writer %}
                <a href="{{ url_for('update', idx=doc.id, page=page) }}"><button type="button" class="btn btn-outline-dark mt-3 text-end">ê¸€ìˆ˜ì •</button></a>
                <button type="button" class="btn btn-outline-danger delbtn" data-bs-toggle="modal" data-bs-target="#a">
                    ê¸€ì‚­ì œ
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="modal fade" id="a" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel"><b>ê²Œì‹œê¸€ ì‚­ì œ ì•Œë¦¼</b></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h5>ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h5>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a href="{{ url_for('delete', idx=doc.id, page=page) }}"><button class="btn btn-danger" style="font-weight: bold;">ê¸€ì‚­ì œ</button></a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}